<UserControl
    x:Class="Indirect.Controls.ReelsControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:helpers="using:Indirect.Utilities"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:wrapper="using:Indirect.Wrapper"
    xmlns:controls="using:Microsoft.Toolkit.Uwp.UI.Controls"
    xmlns:converters="using:Indirect.Converters"
    xmlns:controls1="using:Indirect.Controls"
    mc:Ignorable="d"
    d:DesignHeight="300"
    d:DesignWidth="400">
    <UserControl.Resources>
        <ResourceDictionary>
            <converters:RelativeTimeConverter x:Key="RelativeTimeConverter"/>
            <converters:BooleanVisibilityConverter x:Key="BooleanVisibilityConverter"/>

            <DataTemplate x:Key="ReplyControlTemplate" x:DataType="wrapper:ReelItemWrapper">
                <StackPanel Orientation="Horizontal" Margin="0,4,0,0"
                            Visibility="{x:Bind Parent.CanReply, Converter={StaticResource BooleanVisibilityConverter}, Mode=OneWay}">
                    <TextBox Text="{x:Bind DraftMessage, Mode=TwoWay}" Width="300"
                             TextWrapping="Wrap" Background="Transparent"
                             PlaceholderText="Type a message"
                             Margin="4,0,4,0" MaxLength="2200" 
                             AcceptsReturn="True" KeyboardAcceleratorPlacementMode="Hidden">
                        <TextBox.KeyboardAccelerators>
                            <KeyboardAccelerator Key="Enter" Modifiers="None" Invoked="MessageTextBox_OnEnterPressed"/>
                        </TextBox.KeyboardAccelerators>
                    </TextBox>
                    <Button ToolTipService.ToolTip="Send" Margin="0,0,4,0" Click="SendButton_Click" VerticalAlignment="Bottom" Width="60">
                        <FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph="&#xE724;"/>
                    </Button>
                </StackPanel>
            </DataTemplate>

            <DataTemplate x:Key="VideoTemplate" x:DataType="wrapper:ReelItemWrapper">
                <Grid Margin="0,0,0,6">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <controls1:AutoVideoControl Grid.Row="0"
                                                Source="{x:Bind VideoVersions[0].Url}" VideoWidth="640" VideoHeight="1137"
                                                PosterSource="{x:Bind Images[0].Url}" AutoPlay="True" AutoStop="True" HorizontalAlignment="Stretch" VerticalAlignment="Stretch"/>
                    <ContentPresenter Grid.Row="1" ContentTemplate="{StaticResource ReplyControlTemplate}" Content="{x:Bind}" HorizontalAlignment="Center"/>
                </Grid>
            </DataTemplate>

            <DataTemplate x:Key="ImageTemplate" x:DataType="wrapper:ReelItemWrapper">
                <Grid Margin="0,0,0,6">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <controls:ImageEx Grid.Row="0" Source="{x:Bind Images[0].Url}"/>
                    <ContentPresenter Grid.Row="1" ContentTemplate="{StaticResource ReplyControlTemplate}" Content="{x:Bind}" HorizontalAlignment="Center"/>
                </Grid>
            </DataTemplate>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <ProgressBar x:Name="ReelsProgressBar" Grid.Row="0" Canvas.ZIndex="1" Opacity="0.3" HorizontalAlignment="Stretch"/>
        <Grid Grid.Row="1" Canvas.ZIndex="1">
            <Grid.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="{StaticResource SystemAltMediumLowColor}" Offset="0.0"/>
                    <GradientStop Color="{ThemeResource TintedTransparent}" Offset="1.0"/>
                </LinearGradientBrush>
            </Grid.Background>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <controls:ImageEx Grid.Row="0" Grid.Column="0" Grid.RowSpan="2"
                              Source="{x:Bind StoryView.SelectedItem.(wrapper:ReelItemWrapper.Parent).User.ProfilePictureUrl, Mode=OneWay}" 
                              Height="32" Width="32" Margin="54,0,12,0" CornerRadius="99" VerticalAlignment="Center" Tapped="RedirectToThread"/>
            <TextBlock Grid.Row="0" Grid.Column="1" 
                       Text="{x:Bind StoryView.SelectedItem.(wrapper:ReelItemWrapper.Parent).User.Username, Mode=OneWay}" 
                       Style="{ThemeResource FluentTitleTextStyle}" MaxLines="1" 
                       VerticalAlignment="Center"/>
            <TextBlock Grid.Row="1" Grid.Column="1" Style="{ThemeResource FluentCaptionTextStyle}"
                       Text="{x:Bind StoryView.SelectedItem.(wrapper:ReelItemWrapper.TakenAt), Converter={StaticResource RelativeTimeConverter}, Mode=OneWay}"/>
            <StackPanel Grid.Row="0" Grid.RowSpan="2" Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                <Button IsEnabled="{x:Bind MorePreviousReels, Mode=OneWay}" ToolTipService.ToolTip="Go to previous reel"
                        Background="Transparent" Margin="2" Click="PreviousReelButtonClick">
                    <FontIcon Glyph="&#xE760;"/>
                </Button>
                <Button IsEnabled="{x:Bind MoreNextReels, Mode=OneWay}" ToolTipService.ToolTip="Go to next reel"
                        Background="Transparent" Margin="2,2,4,2" Click="NextReelButtonClick">
                    <FontIcon Glyph="&#xE761;"/>
                </Button>
            </StackPanel>
        </Grid>
        <FlipView x:Name="StoryView" Grid.Row="1" Grid.RowSpan="2" ItemsSource="{x:Bind Source.Items, Mode=OneWay}"
                  Loaded="StoryView_OnLoaded" SelectionChanged="StoryView_OnSelectionChanged">
            <FlipView.ItemTemplateSelector>
                <helpers:StoryTemplateSelector ImageTemplate="{StaticResource ImageTemplate}"
                                               VideoTemplate="{StaticResource VideoTemplate}"/>
            </FlipView.ItemTemplateSelector>
        </FlipView>
    </Grid>
</UserControl>
